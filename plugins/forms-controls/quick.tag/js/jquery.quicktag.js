(function($){$.fn.quickTag=function(options){options=$.extend({limitation:30,triggerKey:13,allowedTags:5,focus:false,coloring:false,colors:["yellow","orange","red"],fade:false,isForm:undefined,img:undefined,counter:undefined,tagList:$("#taglist"),notice:undefined,tagClass:"tag",closeClass:"close"},options);var that=$(this),val=undefined,valLength=0,mainColor=undefined,colorSpots=undefined;return that.each(function(){var quickTag={init:function(){$(options.notice).hide();if($(options.counter)){mainColor=$(options.counter).css("color")}if(options.counter&&options.limitation){this.keyUp();$(that).attr("maxlength",options.limitation);$(options.counter).text(options.limitation)}if(options.img){options.img='<img src="'+options.img+'" alt="Close this tag" />'}options.isForm&&this.secureSubmit();if(options.coloring){options.colors.reverse()}if(options.counter&&options.coloring){colorSpots=this.setColoring()}this.keyDown();this.deleteTag()},keyDown:function(){$(that).keydown(function(e){if(e.keyCode===options.triggerKey){if($(options.tagList).children().length<options.allowedTags){if($(that).val()!=""){quickTag.addTag();$(options.counter).text(options.limitation);$(that).val("")}if(options.isForm){return false}}else{quickTag.displayErr();return false}}else{if(options.counter&&valLength>=options.limitation&&e.keyCode!==options.triggerKey&&e.keyCode!==8){return false}}})},keyUp:function(){$(that).keyup(function(e){valLength=$(this).val().length;if(e.keyCode!==options.triggerKey&&options.counter){$(options.counter).text(options.limitation-valLength)}if(colorSpots){var colorNow=undefined,lastEntry=colorSpots.length-1,rest=options.limitation-valLength;for(var i=lastEntry;i>=0;i--){if(rest<=colorSpots[i]){colorNow=options.colors[i]}}if(rest>colorSpots[lastEntry]){colorNow=mainColor}$(options.counter).css("color",colorNow)}})},addTag:function(){val=$(that).val();if($(options.tagList).is("ul")){$(options.tagList).append('<li class="'+options.tagClass+'"><a class="'+options.closeClass+'">'+(options.img||"x")+"</a> "+val+"</li>")}else{if($(options.tagList).is("div")){$(options.tagList).append('<div class="'+options.tagClass+'"><a class="'+options.closeClass+'">'+(options.img||"x")+"</a> "+val+"</div>")}}},deleteTag:function(){$("."+options.closeClass).live("click",function(){$(this).parent().remove();($(options.notice).is(":visible")&&options.fade)?$(options.notice).stop(true,true).fadeOut(options.fade):$(options.notice).hide();options.focus&&$(that).focus();return false})},displayErr:function(){(options.fade)?$(options.notice).stop(true,true).fadeIn(options.fade):$(options.notice).show()},secureSubmit:function(){if($(options.isForm+":has(input=[type=submit])")){$(options.isForm).find("input[type=submit]").click(function(){return true})}},setColoring:function(){var colorableArea=Math.round(options.limitation),colorSpots=[];for(var i=0,z=1;i<options.colors.length;i++){colorableArea=Math.round(colorableArea/2);while(colorableArea%5!=0){colorableArea+=z}colorSpots.unshift(colorableArea)}return colorSpots}};quickTag.init()})}})(jQuery);