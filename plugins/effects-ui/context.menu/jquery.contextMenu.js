(function($,undefined){$.support.htmlMenuitem=("HTMLMenuItemElement" in window);$.support.htmlCommand=("HTMLCommandElement" in window);var $currentTrigger=null,initialized=false,ignoreThisClick=false,counter=0,namespaces={},menus={},defaults={selector:null,appendTo:null,trigger:"right",autoHide:false,ignoreRightClick:false,delay:200,determinePosition:function($menu){if($.ui&&$.ui.position){$menu.css("display","block").position({my:"center top",at:"center bottom",of:this,offset:"0 5",collision:"fit"}).css("display","none")}else{var offset=this.offset();offset.top+=this.outerHeight();offset.left+=this.outerWidth()/2-$menu.outerWidth()/2;$menu.css(offset)}},position:function(opt,x,y){var $this=this,offset;if(!x&&!y){opt.determinePosition.call(this,opt.$menu);return}else{if(x==="maintain"&&y==="maintain"){offset=opt.$menu.position()}else{offset={top:y,left:x}}}var $win=$(window),bottom=$win.scrollTop()+$win.height(),right=$win.scrollLeft()+$win.width(),height=opt.$menu.height(),width=opt.$menu.width();if(offset.top+height>bottom){offset.top-=height}if(offset.left+width>right){offset.left-=width}opt.$menu.css(offset)},positionSubmenu:function($menu){if($.ui&&$.ui.position){$menu.css("display","block").position({my:"left top",at:"right top",of:this,collision:"fit"}).css("display","")}else{var offset=this.offset();offset.top+=0;offset.left+=this.outerWidth();$menu.css(offset)}},zIndex:1,animation:{duration:50,show:"slideDown",hide:"slideUp"},events:{show:$.noop,hide:$.noop},callback:null,items:{}},hoveract={timer:null,pageX:null,pageY:null},zindex=function($t){var zin=0,$tt=$t;while(true){zin=Math.max(zin,parseInt($tt.css("z-index"),10)||0);$tt=$tt.parent();if(!$tt||!$tt.length||$tt.prop("nodeName").toLowerCase()=="body"){break}}return zin},handle={abortevent:function(e){e.preventDefault();e.stopImmediatePropagation()},contextmenu:function(e){var $this=$(this);e.preventDefault();e.stopImmediatePropagation();if(ignoreThisClick){ignoreThisClick=false;return}if(!$this.hasClass("context-menu-disabled")){$currentTrigger=$this;op.show.call($this,e.data,e.pageX,e.pageY)}},click:function(e){e.preventDefault();e.stopImmediatePropagation();$(this).trigger(jQuery.Event("contextmenu",{data:e.data,pageX:e.pageX,pageY:e.pageY}))},mousedown:function(e){var $this=$(this);if($currentTrigger&&$currentTrigger.length&&!$currentTrigger.is($this)){op.hide.call($currentTrigger,undefined);$currentTrigger=null}if(e.button==2){$currentTrigger=$this.data("contextMenuActive",true)}},mouseup:function(e){var $this=$(this);if($this.data("contextMenuActive")&&$currentTrigger&&$currentTrigger.length&&$currentTrigger.is($this)&&!$this.hasClass("context-menu-disabled")){e.preventDefault();e.stopImmediatePropagation();$currentTrigger=$this;$this.trigger(jQuery.Event("contextmenu",{data:e.data,pageX:e.pageX,pageY:e.pageY}))}$this.removeData("contextMenuActive")},mouseenter:function(e){var $this=$(this),$related=$(e.relatedTarget),$document=$(document);if($related.is(".context-menu-list")||$related.closest(".context-menu-list").length){return}if($currentTrigger&&$currentTrigger.length){return}hoveract.pageX=e.pageX;hoveract.pageY=e.pageY;hoveract.data=e.data;$document.bind("mousemove.contextMenuShow",handle.mousemove);hoveract.timer=setTimeout(function(){hoveract.timer=null;$document.unbind("mousemove.contextMenuShow");$currentTrigger=$this;$this.trigger(jQuery.Event("contextmenu",{data:hoveract.data,pageX:hoveract.pageX,pageY:hoveract.pageY}))},e.data.delay)},mousemove:function(e){hoveract.pageX=e.pageX;hoveract.pageY=e.pageY},mouseleave:function(e){var $related=$(e.relatedTarget);if($related.is(".context-menu-list")||$related.closest(".context-menu-list").length){return}try{clearTimeout(hoveract.timer)}catch(e){}hoveract.timer=null},ignoreRightClick:function(e){if(e.button==2){ignoreThisClick=true}},layerClick:function(e){var $this=$(this),root=$this.data("contextMenuRoot");e.preventDefault();e.stopImmediatePropagation();$this.remove();op.hide.call(root.$trigger,root)},key:function(e){var opt=$currentTrigger.data("contextMenu")||{},$children=opt.$menu.children(),$round;if(!opt.isInput){e.preventDefault()}e.stopPropagation();switch(e.keyCode){case 9:case 38:if(opt.isInput){if(e.keyCode==9&&e.shiftKey){e.preventDefault();opt.$selected&&opt.$selected.find("input, textarea, select").blur();opt.$menu.trigger("prevcommand");break}else{if(e.keyCode==38&&opt.$selected.find("input, textarea, select").prop("type")=="checkbox"){e.preventDefault();break}}}else{if(e.keyCode!=9||e.shiftKey){opt.$menu.trigger("prevcommand");break}}case 9:case 40:if(opt.isInput){if(e.keyCode==9){e.preventDefault();opt.$selected&&opt.$selected.find("input, textarea, select").blur();opt.$menu.trigger("nextcommand")}else{if(e.keyCode==40&&opt.$selected.find("input, textarea, select").prop("type")=="checkbox"){e.preventDefault()}}}else{opt.$menu.trigger("nextcommand")}break;case 37:if(opt.isInput||!opt.$selected||!opt.$selected.length){break}if(!opt.$selected.parent().hasClass("context-menu-root")){var $s=opt.$selected.parent().parent();opt.$selected.removeClass("hover");opt.$selected=$s}break;case 39:if(opt.isInput||!opt.$selected||!opt.$selected.length){break}var itemdata=opt.$selected.data("contextMenu")||{};if(itemdata.$menu){opt.$selected=null;itemdata.$selected=null;itemdata.$menu.trigger("nextcommand")}break;case 13:if(opt.isInput){if(opt.$selected&&!opt.$selected.is(":textarea, :select")){e.preventDefault()}break}opt.$selected&&opt.$selected.trigger("mouseup");break;case 27:op.hide.call($currentTrigger,opt);$currentTrigger=null;break}},prevItem:function(e){e.stopPropagation();var opt=$(this).data("contextMenu")||{};if(opt.$selected){var $s=opt.$selected;opt=opt.$selected.parent().data("contextMenu")||{};opt.$selected=$s}var $children=opt.$menu.children(),$prev=!opt.$selected||!opt.$selected.prev().length?$children.last():opt.$selected.prev(),$round=$prev;while($prev.hasClass("disabled")||$prev.hasClass("not-selectable")){if($prev.prev().length){$prev=$prev.prev()}else{$prev=$children.last()}if($prev.is($round)){return}}if(opt.$selected){handle.itemMouseleave.call(opt.$selected.get(0),e)}handle.itemMouseenter.call($prev.get(0),e);var $input=$prev.find("input, textarea, select");if($input.length){$input.focus()}},nextItem:function(e){e.stopPropagation();var opt=$(this).data("contextMenu")||{};if(opt.$selected){var $s=opt.$selected;opt=opt.$selected.parent().data("contextMenu")||{};opt.$selected=$s}var $children=opt.$menu.children(),$next=!opt.$selected||!opt.$selected.next().length?$children.first():opt.$selected.next(),$round=$next;while($next.hasClass("disabled")||$next.hasClass("not-selectable")){if($next.next().length){$next=$next.next()}else{$next=$children.first()}if($next.is($round)){return}}if(opt.$selected){handle.itemMouseleave.call(opt.$selected.get(0),e)}handle.itemMouseenter.call($next.get(0),e);var $input=$next.find("input, textarea, select");if($input.length){$input.focus()}},focusInput:function(e){var $this=$(this).closest(".context-menu-item"),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.$selected=opt.$selected=$this;root.isInput=opt.isInput=true},blurInput:function(e){var $this=$(this).closest(".context-menu-item"),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.isInput=opt.isInput=false},menuMouseenter:function(e){var root=$(this).data().contextMenuRoot;root.hovering=true},menuMouseleave:function(e){var root=$(this).data().contextMenuRoot;if(root.$layer&&root.$layer.is(e.relatedTarget)){root.hovering=false}},itemMouseenter:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;root.hovering=true;if(root.$layer&&root.$layer.is(e.relatedTarget)){e.preventDefault();e.stopImmediatePropagation()}(data.contextMenu.$menu?data.contextMenu:data.contextMenuRoot).$menu.children().removeClass("hover");if($this.hasClass("disabled")||$this.hasClass("not-selectable")){opt.$selected=null;return}opt.$selected=root.$selected=$this;$this.addClass("hover");if(opt.$node){root.positionSubmenu.call(opt.$node,opt.$menu)}},itemMouseleave:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot;if(root!==opt&&root.$layer&&root.$layer.is(e.relatedTarget)){root.$selected.removeClass("hover");e.preventDefault();e.stopImmediatePropagation();root.$selected=opt.$selected=opt.$node;return}opt.$selected=null;$this.removeClass("hover")},itemClick:function(e){var $this=$(this),data=$this.data(),opt=data.contextMenu,root=data.contextMenuRoot,key=data.contextMenuKey,callback;if(!opt.items[key]||$this.hasClass("disabled")){return}e.preventDefault();e.stopImmediatePropagation();if($.isFunction(root.callbacks[key])){callback=root.callbacks[key]}else{if($.isFunction(root.callback)){callback=root.callback}else{return}}if(callback.call(root.$trigger,key,root)!==false){op.hide.call(root.$trigger,root);$currentTrigger=null}else{op.update.call(root.$trigger,root)}},inputClick:function(e){e.stopImmediatePropagation()}},op={show:function(opt,x,y){var $this=$(this),offset,css={};$("#context-menu-layer").trigger("mousedown");if(opt.events.show.call($this,opt)===false){$currentTrigger=null;return}op.update.call($this,opt);opt.position.call($this,opt,x,y);if(opt.zIndex){css.zIndex=zindex($this)+opt.zIndex}op.layer.call(opt.$menu,opt,css.zIndex);opt.$trigger=$this;opt.$menu.css(css)[opt.animation.show](opt.animation.duration);$this.data("contextMenu",opt);$(document).unbind("keydown.contextMenu").bind("keydown.contextMenu",handle.key);if(opt.autoHide){var pos=$this.position();pos.right=pos.left+$this.outerWidth();pos.bottom=pos.top+this.outerHeight();$(document).bind("mousemove.contextMenuAutoHide",function(e){if(opt.$layer&&!opt.hovering&&(!(e.pageX>=pos.left&&e.pageX<=pos.right)||!(e.pageY>=pos.top&&e.pageY<=pos.bottom))){opt.$layer.trigger("mousedown")}})}},hide:function(opt){var $this=$(this);if(!opt){opt=$this.data("contextMenu")||{}}if(opt.events&&opt.events.hide.call($this,opt)===false){return}if(opt.$layer){try{opt.$layer.remove();delete opt.$layer}catch(e){opt.$layer=null}}$currentTrigger=null;opt.$menu.find(".hover").removeClass("hover");opt.$selected=null;$(document).unbind("keydown.contextMenu").unbind(".contextMenuAutoHide");opt.$menu&&opt.$menu[opt.animation.hide](opt.animation.duration)},create:function(opt,root){if(root===undefined){root=opt}opt.$menu=$('<ul class="context-menu-list '+(this.className||"")+'"></ul>').data({contextMenu:opt,contextMenuRoot:root});$.each(["callbacks","commands","inputs"],function(i,k){opt[k]={};if(!root[k]){root[k]={}}});$.each(opt.items,function(key,item){var $t=$('<li class="context-menu-item '+(item.className||"")+'"></li>'),$label=null,$input=null;item.$node=$t.data({contextMenu:opt,contextMenuRoot:root,contextMenuKey:key});if(typeof item=="string"){$t.addClass("context-menu-separator not-selectable")}else{if(item.type=="html"){$t.addClass("context-menu-html not-selectable")}else{if(item.type){$label=$("<label></label>").appendTo($t);$("<span></span>").appendTo($label).text(item.name);$t.addClass("context-menu-input");opt.hasTypes=true;$.each([opt,root],function(i,k){k.commands[key]=item;k.inputs[key]=item})}else{if(item.items){item.type="sub"}}}switch(item.type){case"text":$input=$('<input type="text" value="1" name="context-menu-input-'+key+'" value="">').val(item.value||"").appendTo($label);break;case"textarea":$input=$('<textarea name="context-menu-input-'+key+'"></textarea>').val(item.value||"").appendTo($label);if(item.height){$input.height(item.height)}break;case"checkbox":$input=$('<input type="checkbox" value="1" name="context-menu-input-'+key+'" value="">').val(item.value||"").prop("checked",!!item.selected).prependTo($label);break;case"radio":$input=$('<input type="radio" value="1" name="context-menu-input-'+item.radio+'" value="">').val(item.value||"").prop("checked",!!item.selected).prependTo($label);break;case"select":$input=$('<select name="context-menu-input-'+key+'">').appendTo($label);if(item.options){$.each(item.options,function(value,text){$("<option></option>").val(value).text(text).appendTo($input)});$input.val(item.selected)}break;case"sub":$("<span></span>").text(item.name).appendTo($t);item.appendTo=item.$node;op.create(item,root);$t.data("contextMenu",item);item.callback=null;break;case"html":$(item.html).appendTo($t);break;default:$.each([opt,root],function(i,k){k.commands[key]=item;if($.isFunction(item.callback)){k.callbacks[key]=item.callback}});$("<span></span>").text(item.name||"").appendTo($t);break}if(item.type&&item.type!="sub"&&item.type!="html"){$input.bind("focus",handle.focusInput).bind("blur",handle.blurInput);if(item.events){$input.bind(item.events)}}if(item.icon){$t.addClass("icon icon-"+item.icon)}}item.$input=$input;item.$label=$label;$t.appendTo(opt.$menu);if(!opt.hasTypes){if($.browser.msie){$t.bind("selectstart.disableTextSelect",handle.abortevent)}else{if(!$.browser.mozilla){$t.bind("mousedown.disableTextSelect",handle.abortevent)}}}});if(!opt.$node){opt.$menu.css("display","none").addClass("context-menu-root")}opt.$menu.appendTo(opt.appendTo||document.body)},update:function(opt){var $this=this;opt.$menu.children().each(function(){var $item=$(this),key=$item.data("contextMenuKey"),item=opt.items[key],disabled=($.isFunction(item.disabled)&&item.disabled.call($this,key,opt))||item.disabled===true;$item[disabled?"addClass":"removeClass"]("disabled");if(item.type){$item.find("input, select, textarea").prop("disabled",disabled);switch(item.type){case"text":case"textarea":item.$input.val(item.value||"");break;case"checkbox":case"radio":item.$input.val(item.value||"").prop("checked",!!item.selected);break;case"select":item.$input.val(item.selected||"");break}}})},layer:function(opt,zIndex){var $win=$(window);return opt.$layer=$('<div id="context-menu-layer" style="position:fixed; z-index:'+zIndex+'; top:0; left:0; opacity: 0;"></div>').css({height:$win.height(),width:$win.width(),display:"block"}).data("contextMenuRoot",opt).insertBefore(this).bind("mousedown",handle.layerClick)}};$.fn.contextMenu=function(operation){if(operation===undefined){this.first().trigger("contextmenu")}else{if(operation.x&&operation.y){this.first().trigger(jQuery.Event("contextmenu",{pageX:operation.x,pageY:operation.y}))}else{if(operation){this.removeClass("context-menu-disabled")}else{if(!operation){this.addClass("context-menu-disabled")}}}}return this};$.contextMenu=function(operation,options){if(typeof operation!="string"){options=operation;operation="create"}if(typeof options=="string"){options={selector:options}}else{if(options===undefined){options={}}}var o=$.extend(true,{},defaults,options||{}),$body=$body=$(document);switch(operation){case"create":if(!o.selector){throw new Error("No selector specified")}if(o.selector.match(/.context-menu-(list|item|input)($|\s)/)){throw new Error('Cannot bind to selector "'+o.selector+'" as it contains a reserved className')}if(!o.items||$.isEmptyObject(o.items)){throw new Error("No Items sepcified")}counter++;o.ns=".contextMenu"+counter;namespaces[o.selector]=o.ns;menus[o.ns]=o;if(!initialized){$body.delegate(".context-menu-list","prevcommand.contextMenu",handle.prevItem).delegate(".context-menu-list","nextcommand.contextMenu",handle.nextItem).delegate(".context-menu-list","contextmenu.contextMenu",handle.abortevent).delegate(".context-menu-list","mouseenter.contextMenu",handle.menuMouseenter).delegate(".context-menu-list","mouseleave.contextMenu",handle.menuMouseleave).delegate(".context-menu-input","mouseup.contextMenu",handle.inputClick).delegate(".context-menu-item","mouseup.contextMenu",handle.itemClick).delegate(".context-menu-item","contextmenu.contextMenu",handle.abortevent).delegate(".context-menu-item","mouseenter.contextMenu",handle.itemMouseenter).delegate(".context-menu-item","mouseleave.contextMenu",handle.itemMouseleave);initialized=true}$body.delegate(o.selector,"contextmenu"+o.ns,o,handle.contextmenu);switch(o.trigger){case"hover":$body.delegate(o.selector,"mouseenter"+o.ns,o,handle.mouseenter).delegate(o.selector,"mouseleave"+o.ns,o,handle.mouseleave);break;case"left":$body.delegate(o.selector,"click"+o.ns,o,handle.click);break}if(o.trigger!="hover"&&o.ignoreRightClick){$body.delegate(o.selector,"mousedown"+o.ns,handle.ignoreRightClick)}op.create(o);break;case"destroy":if(!o.selector){$body.undelegate(".contextMenu").unbind(".contextMenu");$.each(namespaces,function(key,value){$body.undelegate(value)});namespaces={};menus={};counter=0;$(".context-menu-list").remove()}else{if(namespaces[o.selector]){try{if(menus[namespaces[o.selector]].$menu){menus[namespaces[o.selector]].$menu.remove()}delete menus[namespaces[o.selector]]}catch(e){menus[namespaces[o.selector]]=null}$body.undelegate(namespaces[o.selector])}}break;case"html5":if((!$.support.htmlCommand&&!$.support.htmlMenuitem)||(typeof options=="boolean"&&options)){$('menu[type="context"]').each(function(){if(this.id){$.contextMenu({selector:"[contextmenu="+this.id+"]",items:$.contextMenu.fromMenu(this)})}}).css("display","none")}break;default:throw new Error('Unknown operation "'+operation+'"')}return this};$.contextMenu.setInputValues=function(opt,data){if(data===undefined){data={}}$.each(opt.inputs,function(key,item){switch(item.type){case"text":case"textarea":item.value=data[key]||"";break;case"checkbox":item.selected=data[key]?true:false;break;case"radio":item.selected=(data[item.radio]||"")==item.value?true:false;break;case"select":item.selected=data[key]||"";break}})};$.contextMenu.getInputValues=function(opt,data){if(data===undefined){data={}}$.each(opt.inputs,function(key,item){switch(item.type){case"text":case"textarea":case"select":data[key]=item.$input.val();break;case"checkbox":data[key]=item.$input.prop("checked");break;case"radio":if(item.$input.prop("checked")){data[item.radio]=item.value}break}});return data};function inputLabel(node){return(node.id&&$('label[for="'+node.id+'"]').val())||node.name}function menuChildren(items,$children,counter){if(!counter){counter=0}$children.each(function(){var $node=$(this),node=this,nodeName=this.nodeName.toLowerCase(),label,item;if(nodeName=="label"&&$node.find("input, textarea, select").length){label=$node.text();$node=$node.children().first();node=$node.get(0);nodeName=node.nodeName.toLowerCase()}switch(nodeName){case"menu":item={name:$node.attr("label"),items:{}};menuChildren(item.items,$node.children(),counter);break;case"a":case"button":item={name:$node.text(),disabled:!!$node.attr("disabled"),callback:(function(){return function(){$node.click()}})()};break;case"menuitem":case"command":switch($node.attr("type")){case undefined:case"command":case"menuitem":item={name:$node.attr("label"),disabled:!!$node.attr("disabled"),callback:(function(){return function(){node.click()}})()};break;case"checkbox":item={type:"checkbox",disabled:!!$node.attr("disabled"),name:$node.attr("label"),selected:!!$node.attr("checked")};break;case"radio":item={type:"radio",disabled:!!$node.attr("disabled"),name:$node.attr("label"),radio:$node.attr("radiogroup"),value:$node.attr("id"),selected:!!$node.attr("checked")};break;default:item=undefined}break;case"hr":item="-------";break;case"input":switch($node.attr("type")){case"text":item={type:"text",name:label||inputLabel(node),disabled:!!$node.attr("disabled"),value:$node.val()};break;case"checkbox":item={type:"checkbox",name:label||inputLabel(node),disabled:!!$node.attr("disabled"),selected:!!$node.attr("checked")};break;case"radio":item={type:"radio",name:label||inputLabel(node),disabled:!!$node.attr("disabled"),radio:!!$node.attr("name"),value:$node.val(),selected:!!$node.attr("checked")};break;default:item=undefined;break}break;case"select":item={type:"select",name:label||inputLabel(node),disabled:!!$node.attr("disabled"),selected:$node.val(),options:{}};$node.children().each(function(){item.options[this.value]=$(this).text()});break;case"textarea":item={type:"textarea",name:label||inputLabel(node),disabled:!!$node.attr("disabled"),value:$node.val()};break;case"label":break;default:item={type:"html",html:$node.clone(true)};break}if(item){counter++;items["key"+counter]=item}})}$.contextMenu.fromMenu=function(element){var $this=$(element),items={};menuChildren(items,$this.children());return items};$.contextMenu.defaults=defaults})(jQuery);