(function($){$(function(){var COMMON_CHARACTER_ARRANGE_DELAY=1000,REMAINING_CHARACTERS_DELAY=500,EFFECT_DURATION=2000,REMAINING_CHARACTERS_APPEARANCE_MAX_DELAY=2000,REMOVE_CHARACTERS_MAX_DELAY=2000;$.fn.textualizer=function(data,options){var args=arguments;var txtlzr=(function(ele){var obj=ele.data("textualizer");if(!obj){var data=[],options;if(args.length===1&&args[0] instanceof Array){data=args[0]}else{if(args.length===1&&typeof args[0]==="object"){options=args[0]}else{if(args.length===2){data=args[0];options=args[1]}}}if(data.length===0){ele.find("p").each(function(){data.push($(this).text())})}ele.html("");obj=new Textualizer(ele,data,$.extend({},$.fn.textualizer.defaults,options));ele.data("textualizer",obj)}return obj})(this);if(typeof args[0]==="string"&&txtlzr[args[0]]){txtlzr[args[0]].apply(txtlzr,Array.prototype.slice.call(args,1))}return this};$.fn.textualizer.defaults={effect:"random",duration:2000,rearrangeDuration:1000};$.fn.textualizer.effects={none:function(item){this.container.append(item.domNode.show())},fadeIn:function(item,dfd){this.container.append(item.domNode.fadeIn(EFFECT_DURATION,dfd.resolve));return dfd.promise()},slideLeft:function(item,dfd){item.domNode.appendTo(this.container).css({left:-1000}).show().animate({left:item.pos.left},EFFECT_DURATION,dfd.resolve);return dfd.promise()},slideTop:function(item,dfd){item.domNode.appendTo(this.container).css({top:-1000}).show().animate({top:item.pos.top},EFFECT_DURATION,dfd.resolve);return dfd.promise()}};var effectList=[];$.each($.fn.textualizer.effects,function(key,value){if(key!=="none"){effectList.push(key)}});var Blurb=function(){this.str="";this.chars=[]};Blurb.prototype={use:function(c){for(var i=0,len=this.chars.length;i<len;i++){var l=this.chars[i];if(l.ch===c&&!l.used){l.used=true;return l}}return null},reset:function(){$.each(this.chars,function(index,ch){ch.inserted=false;ch.used=false})}};var Character=function(){this.ch=null;this.domNode=null;this.pos=null;this.used=false;this.inserted=false;this.visited=false};function copyStyle(fromElem,toElem){var style;if(window.getComputedStyle){styles=window.getComputedStyle(fromElem[0],null);$.each(styles,function(key,value){toElem.css(value,styles.getPropertyValue(value))})}else{styles=fromElem[0].currentStyle;$.each(styles,function(key,value){toElem.css(key,value)})}}var Textualizer=function(element,data,options){this.options=options;var clone=element.clone().removeAttr("id").appendTo(document.body);copyStyle(element,clone);clone.css({position:"absolute",top:"-1000px"});this.phantomContainer=$("<div />").css({position:"relative",visibility:"hidden"}).appendTo(clone);element.css("overflow","hidden");this.elementHeight=element.height();this.container=$("<div />").css("position","relative").appendTo(element);this._previous=null;this._position={};this._position.bottom=element.height();this.blurbs=[];if(data&&data instanceof Array){this.data(data)}};Textualizer.prototype={data:function(d){this.stop();this.list=d;this.blurbs=[]},start:function(){if(!this.list||this.list.length===0){return}var self=this,index=this._index||0;this._pause=false;function rotate(i){if(self._pause){return}self._rotate(i).done(function(){setTimeout(function(){if(i===self.list.length-1){i=-1;$.each(self.blurbs,function(j,item){item.reset()})}i++;self._index=i;rotate(i)},self.options.duration)})}rotate(index)},stop:function(){this.pause();this._previous=null;this._index=0;this.container.empty();this.phantomContainer.empty()},pause:function(){this._pause=true},_rotate:function(index){var dfd=$.Deferred(),current=this.blurbs[index];if(!current){var phantomBlurbs=[],i,len,ch,c;current=new Blurb();current.str=this.list[index];this.blurbs.push(current);for(i=0,len=current.str.length;i<len;i++){ch=current.str.charAt(i);if(ch===""){this.phantomContainer.append(" ")}else{c=new Character();c.ch=ch;c.domNode=$("<span/>").text(ch);this.phantomContainer.append(c.domNode);phantomBlurbs.push(c)}}var height=this.options.centered?(this.elementHeight-this.phantomContainer.height())/2:0;$.each(phantomBlurbs,function(index,c){c.pos=c.domNode.position();c.domNode=c.domNode.clone();c.pos.top+=height;c.domNode.css({left:c.pos.left,top:c.pos.top,position:"absolute"});current.chars.push(c)});this.phantomContainer.html("")}if(this._previous){var self=this,keepList=[],removeList=[],dfds=[];var randomHideEffect=getRandomHideEffect.call(this);$.each(this._previous.chars,function(index,prevC){var currC=current.use(prevC.ch);if(currC){currC.domNode=prevC.domNode;currC.inserted=true;keepList.push(currC)}else{var d=$.Deferred();removeList.push(d);randomHideEffect(prevC.domNode.delay(Math.random()*REMOVE_CHARACTERS_MAX_DELAY)).done(function(){prevC.domNode.remove();d.resolve()})}});$.when.apply(null,removeList).done(function(){setTimeout(function(){$.each(keepList,function(index,item){var d=$.Deferred();item.domNode.animate({left:item.pos.left,top:item.pos.top},self.options.rearrangeDuration,d.resolve);dfds.push(d.promise())});$.when.apply(null,dfds).done(function(){setTimeout(function(){showCharacters.call(self,current).done(function(){dfd.resolve()})},REMAINING_CHARACTERS_DELAY)})},COMMON_CHARACTER_ARRANGE_DELAY)})}else{showCharacters.call(this,current).done(function(){dfd.resolve()})}this._previous=current;return dfd.promise()},destroy:function(){this.container.parent().removeData("textualizer").end().remove();this.phantomContainer.remove()}};function getRandomHideEffect(){var self=this;var eff=[function(target){var d=$.Deferred();target.animate({top:self._position.bottom,opacity:"hide"},d.resolve);return d.promise()},function(target){var d=$.Deferred();target.fadeOut(1000,d.resolve);return d.promise()}];return eff[Math.floor(Math.random()*eff.length)]}function showCharacters(item){var self=this,effect=this.options.effect==="random"?$.fn.textualizer.effects[effectList[Math.floor(Math.random()*effectList.length)]]:$.fn.textualizer.effects[this.options.effect],finalDfd=$.Deferred(),animationDfdList=[];$.each(item.chars,function(index,ch){if(!ch.inserted){ch.domNode.css({left:ch.pos.left,top:ch.pos.top});var animationDfd=$.Deferred();setTimeout(function(){effect.call(self,ch,animationDfd)},Math.random()*REMAINING_CHARACTERS_APPEARANCE_MAX_DELAY);animationDfdList.push(animationDfd)}});$.when.apply(null,animationDfdList).done(function(){finalDfd.resolve()});return finalDfd.promise()}})})(jQuery);